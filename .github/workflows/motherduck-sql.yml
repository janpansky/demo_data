name: Append New Data to MotherDuck Daily

on:
  schedule:
    - cron: '0 3 * * *'  # Runs every day at 3 AM UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  append_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install DuckDB CLI
        run: |
          wget https://github.com/duckdb/duckdb/releases/download/v0.9.2/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          chmod +x duckdb
          sudo mv duckdb /usr/local/bin/

      - name: Authenticate with MotherDuck
        run: |
          duckdb -c "
          INSTALL motherduck;
          LOAD motherduck;
          CALL md_auth('${{ secrets.MOTHERDUCK_TOKEN }}');"

      - name: Append Only New Data to Tables
        run: |
          duckdb -c "
          ATTACH 'md:your_database_name' AS md;

          INSERT INTO md.customer
          SELECT new.*
          FROM read_csv_auto(
            'https://raw.githubusercontent.com/janpansky/demo_data/refs/heads/main/data/customer.csv',
            MD_RUN='REMOTE'
          ) AS new
          LEFT JOIN md.customer existing ON new.customer_id = existing.customer_id
          WHERE existing.customer_id IS NULL;

          INSERT INTO md.monthly_inventory
          SELECT new.*
          FROM read_csv_auto(
            'https://raw.githubusercontent.com/janpansky/demo_data/refs/heads/main/data/monthly_inventory.csv',
            MD_RUN='REMOTE'
          ) AS new
          LEFT JOIN md.monthly_inventory existing ON new.monthly_inventory_id = existing.monthly_inventory_id
          WHERE existing.monthly_inventory_id IS NULL;

          INSERT INTO md.order_lines
          SELECT new.*
          FROM read_csv_auto(
            'https://raw.githubusercontent.com/janpansky/demo_data/refs/heads/main/data/order_lines.csv',
            MD_RUN='REMOTE'
          ) AS new
          LEFT JOIN md.order_lines existing ON new.order_line_id = existing.order_line_id
          WHERE existing.order_line_id IS NULL;

          INSERT INTO md.orders
          SELECT new.*
          FROM read_csv_auto(
            'https://raw.githubusercontent.com/janpansky/demo_data/refs/heads/main/data/orders.csv',
            MD_RUN='REMOTE'
          ) AS new
          LEFT JOIN md.orders existing ON new.order_id = existing.order_id
          WHERE existing.order_id IS NULL;

          INSERT INTO md.product
          SELECT new.*
          FROM read_csv_auto(
            'https://raw.githubusercontent.com/janpansky/demo_data/refs/heads/main/data/product.csv',
            MD_RUN='REMOTE'
          ) AS new
          LEFT JOIN md.product existing ON new.product_id = existing.product_id
          WHERE existing.product_id IS NULL;

          INSERT INTO md.returns
          SELECT new.*
          FROM read_csv_auto(
            'https://raw.githubusercontent.com/janpansky/demo_data/refs/heads/main/data/returns.csv',
            MD_RUN='REMOTE'
          ) AS new
          LEFT JOIN md.returns existing ON new.return_id = existing.return_id
          WHERE existing.return_id IS NULL;
          "
